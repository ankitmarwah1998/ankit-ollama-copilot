name: Analyze PR with Ollama

on:
  pull_request:

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›’ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # important for diff

      - name: ðŸ§  Generate PR Diff
        run: |
          git fetch origin main
          git diff origin/main...HEAD > pr.diff || echo "" > pr.diff

      - name: ðŸ“¦ Prepare Infra File
        run: |
          mkdir -p infra
          find . -name "*.yaml" -o -name "*.yml" > infra/infra_files.txt
          cat $(cat infra/infra_files.txt) > infra_content.txt || echo "" > infra_content.txt

      - name: ðŸ¤– Call AI API for PR Diff Analysis
        run: |
          curl -s -X POST "${{ secrets.NGROK_URL }}/analyze" \
            -H "Content-Type: application/json" \
            -d "{\"diff\": $(jq -Rs . < pr.diff)}" \
            -o diff_response.json || echo '{"analysis":"âš ï¸ Failed to get AI response"}' > diff_response.json

      - name: ðŸ’° Call AI API for Infra Cost Estimation
        run: |
          curl -s -X POST "${{ secrets.NGROK_URL }}/estimate" \
            -H "Content-Type: application/json" \
            -d "{\"infra\": $(jq -Rs . < infra_content.txt)}" \
            -o infra_response.json || echo '{"analysis":"âŒ No cost estimation"}' > infra_response.json

      - name: ðŸ“ Create comment markdown
        run: |
          AI_ANALYSIS=$(jq -r '.analysis' diff_response.json)
          COST_ESTIMATION=$(jq -r '.analysis' infra_response.json)

          echo "### ðŸ¤– AI Code Review Suggestion:" > comment.md
          echo "$AI_ANALYSIS" >> comment.md
          echo "" >> comment.md
          echo "### ðŸ’° Estimated Infra Cost Impact:" >> comment.md
          echo "$COST_ESTIMATION" >> comment.md

      - name: ðŸ’¬ Post comment on PR
        run: gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

