name: Analyze PR with AI & Estimate Cost

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: 🧾 Checkout Repository
        uses: actions/checkout@v3

      - name: 🛠 Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: 📦 Install Dependencies
        run: |
          pip install jq || sudo apt-get install jq -y || true

      - name: 📤 Generate PR Diff
        run: |
          git fetch origin main
          git diff origin/main...HEAD > pr.diff

      - name: 📤 Read Infra File
        run: |
          if [ -f infra.tf ]; then
            cat infra.tf > infra_content.txt
          else
            echo "No infra.tf file found, using placeholder."
            echo "resource \"aws_instance\" \"example\" {}" > infra_content.txt
          fi

      - name: 🤖 Send Diff to AI (code review)
        run: |
          curl -s -X POST "${{ secrets.NGROK_URL }}/analyze" \
            -H "Content-Type: application/json" \
            -d "$(jq -Rs '{diff: .}' pr.diff)" \
            -o diff_response.json || echo '{"analysis":"⚠️ Failed to get AI response"}' > diff_response.json

      - name: 💰 Send Infra to AI (cost estimation)
        run: |
          curl -s -X POST "${{ secrets.NGROK_URL }}/estimate" \
            -H "Content-Type: application/json" \
            -d "$(jq -Rs '{infra: .}' infra_content.txt)" \
            -o infra_response.json || echo '{"analysis":"⚠️ Failed to get cost estimation"}' > infra_response.json

      - name: 🐛 Debug Print AI Responses (Optional)
        run: |
          echo "AI Code Review Response:"
          cat diff_response.json
          echo "Infra Cost Estimation Response:"
          cat infra_response.json

      - name: 💬 Comment on PR
        run: bash scripts/comment-pr.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}

