name: Analyze PR with Ollama

on:
  pull_request:
    branches:
      - main

jobs:
  analyze:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    env:
      PR_URL: ${{ github.event.pull_request.html_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flask

      - name: Start Flask app
        run: |
          nohup python app.py > flask.log 2>&1 &
          sleep 5
          curl -s localhost:5000 || true

      - name: Analyze PR diff
        run: |
          git fetch origin main
          DIFF=$(git diff origin/main...HEAD)
          echo "$DIFF"
          curl -X POST http://localhost:5000/analyze \
            -H "Content-Type: application/json" \
            -d "{\"diff\": \"$DIFF\"}" > response.json

      - name: Comment on PR
        run: bash scripts/comment-pr.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

