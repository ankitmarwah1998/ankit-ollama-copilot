name: Analyze PR with Ollama

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ” Extract PR diff
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > pr.diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“„ Read infra file (e.g. infra/main.tf)
        run: |
          cat infra/main.tf > infra_content.txt || echo "No infra file found" > infra_content.txt

      - name: ðŸ”§ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: ðŸ¤– Call AI API for Code Review
        run: |
          curl -s -X POST "${{ secrets.NGROK_URL }}/analyze" \
            -H "Content-Type: application/json" \
            -d "$(jq -Rs '{diff: .}' pr.diff)" \
            -o diff_response.json || echo '{"analysis":"âš ï¸ Failed to get AI response"}' > diff_response.json

      - name: ðŸ’° Call AI API for Infra Cost Estimation
        run: |
          curl -s -X POST "${{ secrets.NGROK_URL }}/estimate" \
            -H "Content-Type: application/json" \
            -d "$(jq -Rs '{infra: .}' infra_content.txt)" \
            -o infra_response.json || echo '{"analysis":"âš ï¸ Failed to get cost estimation"}' > infra_response.json

      - name: ðŸ› Debug: Show AI response
        run: |
          echo "===== DIFF ANALYSIS ====="
          cat diff_response.json
          echo "===== COST ESTIMATION ====="
          cat infra_response.json

      - name: ðŸ“ Create comment markdown
        run: |
          AI_ANALYSIS=$(jq -r '.analysis' diff_response.json)
          COST_ESTIMATION=$(jq -r '.analysis' infra_response.json)

          echo "### ðŸ¤– AI Code Review Suggestion:" > comment.md
          echo "$AI_ANALYSIS" >> comment.md
          echo "" >> comment.md
          echo "### ðŸ’° Estimated Infra Cost Impact:" >> comment.md
          echo "$COST_ESTIMATION" >> comment.md

      - name: ðŸ’¬ Post comment on PR
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

