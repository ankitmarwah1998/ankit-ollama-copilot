name: Analyze PR with Ollama

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout repo
        uses: actions/checkout@v3

      - name: ðŸ›  Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ðŸ“¦ Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt found, skipping install"
          fi

      - name: ðŸ“¤ Generate PR Diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
          git fetch origin ${{ github.event.pull_request.head.ref }} --depth=1
          git diff origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} > pr.diff

      - name: ðŸ¤– Send Diff to Ollama API
        run: |
          ESCAPED_DIFF=$(sed ':a;N;$!ba;s/"/\\"/g;s/\n/\\n/g' pr.diff)
          curl -X POST https://5b87-182-74-161-50.ngrok-free.app/analyze \
            -H "Content-Type: application/json" \
            -d "{\"diff\": \"$ESCAPED_DIFF\"}" \
            > response.json

      - name: ðŸ” Set PR URL in Environment
        run: echo "PR_URL=${{ github.event.pull_request.html_url }}" >> $GITHUB_ENV

      - name: ðŸ’¬ Add Ollama AI Response to PR as Comment
        run: bash scripts/comment-pr.sh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ env.PR_URL }}

