name: Analyze PR with Ollama

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§¾ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Needed for full diff

      - name: ðŸ›  Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ðŸ“¦ Install dependencies
        run: |
          pip install -r requirements.txt || true
          sudo apt update && sudo apt install -y jq

      - name: ðŸ“¤ Generate PR Diff
        run: |
          git fetch origin
          git diff origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} > pr.diff

      - name: ðŸ“„ Extract infra.yaml content
        run: |
          if [ -f infra.yaml ]; then
            cp infra.yaml infra.yaml.temp
          else
            echo "" > infra.yaml.temp
          fi

      - name: ðŸ¤– Send PR Diff to Ollama API
        run: |
          ESCAPED_DIFF=$(sed ':a;N;$!ba;s/"/\\"/g;s/\n/\\n/g' pr.diff)
          curl -s -X POST "${{ secrets.NGROK_URL }}/analyze" \
            -H "Content-Type: application/json" \
            -d "{\"diff\": \"$ESCAPED_DIFF\"}" \
            > diff_response.json

      - name: ðŸ¤– Send Infra.yaml to Ollama API
        run: |
          ESCAPED_INFRA=$(sed ':a;N;$!ba;s/"/\\"/g;s/\n/\\n/g' infra.yaml.temp)
          curl -s -X POST "${{ secrets.NGROK_URL }}/analyze" \
            -H "Content-Type: application/json" \
            -d "{\"infra\": \"$ESCAPED_INFRA\"}" \
            > infra_response.json

      - name: ðŸ’¬ Create Markdown Comment
        run: |
          AI_ANALYSIS=$(jq -r '.analysis' diff_response.json 2>/dev/null || echo "âš ï¸ Failed to get AI response")
          COST_ESTIMATION=$(jq -r '.analysis' infra_response.json 2>/dev/null || echo "âš ï¸ Failed to get cost estimation")

          echo "### ðŸ¤– **AI Code Review Suggestion:**" > comment.md
          echo "$AI_ANALYSIS" >> comment.md
          echo "" >> comment.md
          echo "### ðŸ’° **Estimated Infra Cost Impact:**" >> comment.md
          echo "$COST_ESTIMATION" >> comment.md

      - name: ðŸ’¬ Post AI Comment on PR
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

