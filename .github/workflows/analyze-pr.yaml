name: Analyze PR with Ollama

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      - name: 🧪 Generate PR diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > pr.diff

      - name: 📄 Read IaC/infra content
        run: |
          if [ -f "infra.tf" ]; then cat infra.tf > infra_content.txt
          elif [ -f "infrastructure.yaml" ]; then cat infrastructure.yaml > infra_content.txt
          elif [ -f "iac.json" ]; then cat iac.json > infra_content.txt
          else echo "No infra file found" > infra_content.txt; fi

      - name: 🤖 Call AI API for Code Review
        run: |
          set -e
          RESPONSE=$(curl -s -X POST "${{ secrets.NGROK_URL }}/analyze" \
            -H "Content-Type: application/json" \
            -d "$(jq -Rs '{diff: .}' pr.diff)" || echo '{"analysis":"⚠️ Failed to get AI response"}')
          echo "$RESPONSE" > diff_response.json

      - name: 💰 Call AI API for Infra Cost Estimation
        run: |
          set -e
          RESPONSE=$(curl -s -X POST "${{ secrets.NGROK_URL }}/estimate" \
            -H "Content-Type: application/json" \
            -d "$(jq -Rs '{infra: .}' infra_content.txt)" || echo '{"analysis":"⚠️ Failed to get cost estimation"}')
          echo "$RESPONSE" > infra_response.json

      - name: 🪵 Debug: Show AI response
        run: |
          echo "===== DIFF ANALYSIS ====="
          cat diff_response.json
          echo "===== COST ESTIMATION ====="
          cat infra_response.json

      - name: 📝 Create comment markdown
        run: |
          AI_ANALYSIS=$(jq -r '.analysis' diff_response.json)
          COST_ESTIMATION=$(jq -r '.analysis' infra_response.json)

          echo "### 🤖 AI Code Review Suggestion:" > comment.md
          echo "$AI_ANALYSIS" >> comment.md
          echo "" >> comment.md
          echo "### 💰 Estimated Infra Cost Impact:" >> comment.md
          echo "$COST_ESTIMATION" >> comment.md

      - name: 💬 Post comment on PR
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

