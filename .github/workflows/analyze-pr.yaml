name: Analyze PR with Ollama

on:
pull_request:
types: [opened, synchronize]

jobs:
analyze:
runs-on: ubuntu-latest

steps:
  - name: ğŸ§¾ Checkout repo
    uses: actions/checkout@v3

  - name: ğŸ›  Set up Python
    uses: actions/setup-python@v4
    with:
      python-version: '3.10'

  - name: ğŸ“¦ Install dependencies
    run: pip install -r requirements.txt

  - name: ğŸ“¤ Generate PR Diff
    run: |
      git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1
      git fetch origin ${{ github.event.pull_request.head.ref }} --depth=1
      git diff origin/${{ github.event.pull_request.base.ref }}...origin/${{ github.event.pull_request.head.ref }} > pr.diff

  - name: ğŸ¤– Send Diff to Ollama API
    run: |
      curl -X POST https://5b87-182-74-161-50.ngrok-free.app/analyze \
        -H "Content-Type: application/json" \
        -d "{\"diff\": \"$(sed ':a;N;$!ba;s/\\n/\\\\n/g' pr.diff | sed 's/\"/\\\\\"/g')\"}" \
        > response.json

  - name: ğŸ” Add Ollama AI Response to PR as Comment
    run: bash scripts/comment-pr.sh
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_EVENT_PATH: ${{ github.event_path }}

